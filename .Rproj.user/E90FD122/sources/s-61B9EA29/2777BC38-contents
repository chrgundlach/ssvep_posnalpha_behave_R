---
title: "Behavioral Analysis Posner+SSVEP paradigm"
author: '[Christopher Gundlach](https://www.researchgate.net/profile/Christopher_Gundlach)'
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---
# Initialisierung  
**Setting up R libraries**

```{r set up libraries,echo=FALSE,warning=FALSE,message=FALSE,results="hide"}
# Setup the work environment
options(width=120,scipen=0,digits=6) # change output width (for better printing), scientific notation (to disable it: scipen=999), constrain output to 3 decimals
cat("\014") # clear console
# dev.off() # clear plots (if no plots are present, comment it out or it will throw an error)
rm(list=ls()) # clear environment
wd="C:/Users/psy05cvd/Dropbox/work/R-statistics/experiments/ssvep_posnalpha_behave/" # work directory
setwd(wd) # set work directory

# Load relevant libraries:
library(plyr)
library(psych)
library(ez)
library(ggplot2)
library(schoRsch)
library(lsr)
library(kableExtra)
library(ggbeeswarm)
library(afex)
library(lmerTest)
library(emmeans)
library(lsmeans)
library(sjPlot)
library(viridis)

library(cowplot)
library(dplyr)
library(readr)

library(ggpol)

source('C:/Users/psy05cvd/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/R_rainclouds.R')
source('C:/Users/psy05cvd/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/summarySE.R')
source('C:/Users/psy05cvd/Dropbox/work/R-statistics/general_functions/RainCloudPlots/tutorial_R/simulateData.R')

datafile1 <- "C:/Users/psy05cvd/Dropbox/work/R-statistics/experiments/ssvep_posnalpha_behave/data_in/Behavior_singletrials.txt"

```
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Analysis of Behavioral Data (Posner Paradigma)  
<br>  

## subaveraged Daten werden geladen
Loading data `r toString(datafile1)`

The data has the following structure

* trialnumber = trial
* blocknumber
* trial_timing_type = 1=regular; 2=control
* cue_validity = 1=valid, 2=invalid, 3=neutral
* cue_validity_label
* cue_direction = 1=left, 2=right
* cue_direction_label
* cue_onset_fr = frame number of cue presentation
* cue_onset_t_est = onset time in ms
* cue_onset_t_meas = nan
* pre_event_type = 1=shorter, 2=longer, NaN=no event
* pre_event_onset_fr = onset frame of event
* pre_event_onset_t_est = onset time in ms
* pre_event_onset_t_meas = nan
* post_event_pos = position of post event: 1 = left, 2=right
* post_event_pos_label
* post_event_direction = direction of target (-90:90)=top; 
* post_event_direction_c = category of target position: 1=top; 2=bottom
* post_event_direction_c_l = label
* post_event_dimenstion = size in degrees
* post_event_onset_fr = onset frames of event
* post_event_onset_t_est = onset times of events
* post_event_onset_t_meas = nan
* triggernum = trigger number
* pre_hit = empty=no event, TRUE=hit, 0=error, NaN=miss
* pre_RT = RT in ms
* post_hit = TRUE=hit, 0=error, NaN=miss
* post_RT = RT in ms
* subject



```{r load data,echo=FALSE,warning=FALSE,message=FALSE,results="hide"}
# Load the data
DATA.In_long <- read.csv(datafile1, header=TRUE,check.names=FALSE, sep =",", dec = ".")
#str(DATA.In_long)
DATA.In_long$trialnumber <- as.factor(DATA.In_long$trialnumber)
DATA.In_long$blocknumber <- as.factor(DATA.In_long$blocknumber)
DATA.In_long$trial_timing_type <- as.factor(DATA.In_long$trial_timing_type)
DATA.In_long$cue_validity <- as.factor(DATA.In_long$cue_validity)
DATA.In_long$cue_direction <- as.factor(DATA.In_long$cue_direction)
DATA.In_long$pre_event_type <- as.factor(DATA.In_long$pre_event_type)
DATA.In_long$post_event_pos <- as.factor(DATA.In_long$post_event_pos)
DATA.In_long$post_event_direction_c <- as.factor(DATA.In_long$post_event_direction_c)
```

# Illustration of Data  
<br> 

1a  Illustrate Data as is

* separate for left and right target

<br>  

```{r plot_data_st, results = "hide",  fig.height=4, fig.width=8, warning = FALSE}
dat_plot <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label,side=post_event_pos_label, post_hit, mean_RT, rate_perc, n_resp, n_cons)
  # filter(post_hit == "error")
#mutate(time=factor(time, levels = c('pre', 'post'), ordered = T))

ggplot(dat_plot, aes(x=validity, y=rate_perc, fill=validity, color = validity)) +
  geom_violin(trim=FALSE, alpha=0.2, color="white")+
  geom_line(aes(group = subject),alpha = 0.5, colour = "grey60") +
  geom_beeswarm(cex=2.5, size = 3.5, shape=21,color="grey60",alpha=0.6)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =validity), geom='errorbar', width=0.9, size=1.5) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5,lwd=1)+
  facet_grid(.~side)+
  theme(legend.position="bottom")+
  theme_classic()+
  xlab("validity")+
  ylab("correct response in %")
  
ggplot(dat_plot, aes(x=validity, y=mean_RT, fill=validity, color = validity)) +
  geom_violin(trim=FALSE, alpha=0.2, color="white")+
  geom_line(aes(group = subject),alpha = 0.5, colour = "grey60") +
  geom_beeswarm(cex=2.5, size = 3.5, shape=21,color="grey60",alpha=0.6)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =validity), geom='errorbar', width=0.9, size=1.5) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5,lwd=1)+
  facet_grid(.~side)+
  theme(legend.position="bottom")+
  theme_classic()+
  xlab("validity")+
  ylab("reaction time in ms")


  
  
  
```



1b  Illustrate Data as is

* averaged across left and right targets

<br>  

```{r plot_data_st_avg, results = "hide",  fig.height=4, fig.width=5, warning = FALSE}
dat_plot <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_hit) %>% 
  summarise(n_resp= sum(n_resp), mean_RT = mean(mean_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label, post_hit, mean_RT, rate_perc, n_resp, n_cons)

ggplot(dat_plot, aes(x=validity, y=rate_perc, fill=validity, color = validity)) +
  geom_violin(trim=FALSE, alpha=0.2, color="white")+
  geom_line(aes(group = subject),alpha = 0.5, colour = "grey60") +
  geom_beeswarm(cex=2.5, size = 3.5, shape=21,color="grey60",alpha=0.6)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =validity), geom='errorbar', width=0.9, size=1.5) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5,lwd=1)+
  # facet_grid(.~side)+
  theme(legend.position="bottom")+
  theme_classic()+
  xlab("validity")+
  ylab("correct response in %")
  
ggplot(dat_plot, aes(x=validity, y=mean_RT, fill=validity, color = validity)) +
  geom_violin(trim=FALSE, alpha=0.2, color="white")+
  geom_line(aes(group = subject),alpha = 0.5, colour = "grey60") +
  geom_beeswarm(cex=2.5, size = 3.5, shape=21,color="grey60",alpha=0.6)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =validity), geom='errorbar', width=0.9, size=1.5) +
  stat_summary(fun.data=mean_se, geom="errorbar", width=0.5,lwd=1)+
  # facet_grid(.~side)+
  theme(legend.position="bottom")+
  theme_classic()+
  xlab("validity")+
  ylab("reaction time in ms")
```


## decriptive data 
<br>  

### behavioral measures

validity x side

```{r R_valXside, echo=FALSE}
DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  group_by(cue_validity_label, post_event_pos_label) %>%
  summarise(M_reaction_time = mean(mean_RT), SD_reaction_time = sd(mean_RT),  
            M_response_rate = mean(rate_perc), SD_response_rate = sd(rate_perc))%>%
  ungroup()%>%
  mutate(cue_validity_label = factor(cue_validity_label, levels=c('invalid','neutral','valid'), ordered = T))%>%
  select(validity=cue_validity_label,side=post_event_pos_label, M_reaction_time, SD_reaction_time, M_response_rate,SD_response_rate)%>%
  kable(escape = F, digits = c(3,3,3,6,3,3,3,3,3), caption = c("average response measures")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

validity

```{r R_val, echo=FALSE}
DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  group_by(cue_validity_label) %>%
  summarise(M_reaction_time = mean(mean_RT), SD_reaction_time = sd(mean_RT),  
            M_response_rate = mean(rate_perc), SD_response_rate = sd(rate_perc))%>%
  ungroup()%>%
  mutate(cue_validity_label = factor(cue_validity_label, levels=c('invalid','neutral','valid'), ordered = T))%>%
  select(validity=cue_validity_label, M_reaction_time, SD_reaction_time, M_response_rate,SD_response_rate)%>%
  kable(escape = F, digits = c(3,3,3,6,3,3,3,3,3), caption = c("average response measures")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

side

```{r R_side, echo=FALSE}
DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  group_by(post_event_pos_label) %>%
  summarise(M_reaction_time = mean(mean_RT), SD_reaction_time = sd(mean_RT),  
            M_response_rate = mean(rate_perc), SD_response_rate = sd(rate_perc))%>%
  ungroup()%>%
  select(side=post_event_pos_label, M_reaction_time, SD_reaction_time, M_response_rate,SD_response_rate)%>%
  kable(escape = F, digits = c(3,3,3,6,3,3,3,3,3), caption = c("average response measures")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

## tests  
<br>  

test of general model

### ANOVA RT
<br>  

ANOVA_RM for reaction time: VALIDTIY(invalid, neutral, valid) X SIDE (left, right)

```{r ANOVA_RT_ValXSei, message=FALSE, warning=FALSE, include=TRUE}
#ANOVAe
StatsOut <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label,side=post_event_pos_label, post_hit, mean_RT, rate_perc, n_resp, n_cons)%>%
  aov_ez(id="subject", dv = "mean_RT", data = ., within = c("validity","side"), include_aov = afex_options("include_aov"))
StatsOut%>%
  .$anova_table %>%
  mutate(factor = rownames(.))%>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(factor, `num Df`, `den Df`, MSE, `F`, ges, `Pr(>F)`) %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("repeated measures ANOVA | dv = RT")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```

### Post-hoc t-Tests RT  
<br>


```{r post-hoc t_tests RT, echo=FALSE}
# aggregate data


post_hocs.valXside <- emmeans(StatsOut$aov, c("validity","side"), contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.validity <- emmeans(StatsOut$aov, c("validity"), contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.side <- emmeans(StatsOut$aov, c("side"), contr = "pairwise",adjust = "holm") # adjust = holm

# report data
post_hocs.validity$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by validity | dv = RT")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.validity$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by validity | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.side$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by side | dv = RT")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.side$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by side | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.valXside$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by validity and side | dv = RT")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.valXside$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by validity and side | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
  
  
```

### ANOVA RR
<br>  

ANOVA_RM for reaction time: VALIDTIY(invalid, neutral, valid) X SIDE (left, right)

```{r ANOVA_RR_ValXSei, message=FALSE, warning=FALSE, include=TRUE}
#ANOVAe
StatsOut <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label,side=post_event_pos_label, post_hit, mean_RT, rate_perc, n_resp, n_cons)%>%
  aov_ez(id="subject", dv = "rate_perc", data = ., within = c("validity","side"), include_aov = afex_options("include_aov"))
StatsOut%>%
  .$anova_table %>%
  mutate(factor = rownames(.))%>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(factor, `num Df`, `den Df`, MSE, `F`, ges, `Pr(>F)`) %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("repeated measures ANOVA | dv = response rate")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

```


### Post-hoc t-Tests response rate 
<br>


```{r post-hoc t_tests RR, echo=FALSE}
# aggregate data


post_hocs.valXside <- emmeans(StatsOut$aov, c("validity","side"), contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.validity <- emmeans(StatsOut$aov, c("validity"), contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.side <- emmeans(StatsOut$aov, c("side"), contr = "pairwise",adjust = "holm") # adjust = holm

# report data
post_hocs.validity$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by validity | dv = reponse rate")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.validity$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by validity | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.side$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by side | dv = reponse rate")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.side$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by side | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.valXside$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by validity and side | dv = reponse rate")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.valXside$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by validity and side | dv = RT | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
  
  
```


## Additional models
<br>

### linear mixed models RT
<br>

1.  **estimating model**
<br>

linear mixed model of standard effects based on averaged data

testing **reaction time ~ Validitaet * Seite + ( 1 | subjects)**


```{r linear mixed model RT 01 - estimation, echo=FALSE, message=FALSE}

lmer_model_data <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label,side=post_event_pos_label, post_hit, mean_RT, rate_perc, n_resp, n_cons) %>%
  ungroup()

model_valXside <-lmerTest::lmer(mean_RT ~ validity * side + ( 1 | subject),
                  data=lmer_model_data, REML=TRUE)
model_estimation <- lmerTest::step(model_valXside, ddf="Kenward-Roger", reduce.random=FALSE)
best_model <- get_model(model_estimation)

# print model estimation
model_estimation$fixed %>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")) %>%
  mutate(`eliminated factor` = rownames(model_estimation$fixed)) %>%
  dplyr::select(colnames(.)[c(8,1:7)]) %>%
  kable(escape = F, digits = c(3,3,3,3), caption = c("fixed effects | stepwise elimination")) %>%
  kable_styling("striped", full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8),position = "left")
```
2.  model description of best model
    + Best model is `r toString(best_model@call)`  
<br>

``` {r linear mixed model RT 01 - display, fig.height=6, fig.width=10, warning=FALSE}

model2test = best_model
model2test = model_valXside

## validity
anova_lsmeans_c <- lsmeans(model2test, c("validity")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = validity, y = lsmean, color = validity, fill = validity, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.4),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for validity") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0, -0),
            nudge_y = c(26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")
  
## Seite
anova_lsmeans_c <- lsmeans(model2test, c("side")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = side, y = lsmean, color = side, fill = side, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.4),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for side") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0, -0),
            nudge_y = c(26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")

## Validiaet X Seite
anova_lsmeans_c <- lsmeans(model2test, c("side","validity")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = validity, y = lsmean, color = side, fill = side, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.9),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for side") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0.22, -0.22, 0.22, -0.22),
            nudge_y = c(26.7,  26.7,26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")


plot_model(model2test, bpe.style = "dot",show.values = TRUE)
plot_model(model2test, type = "pred", terms = c("side","validity"))
plot_model(model2test, type = "pred", terms = c("validity","side"))

```

### linear mixed models RT II
<br>

1.  **estimating model**
<br>

linear mixed model of standard effects based on single trial data

testing **reaction time ~ Validitaet * Seite + ( 1 | subjects)**


```{r linear mixed model RT 02 - estimation, echo=FALSE, message=FALSE}
lmer_model_data2 <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  select(subject,trialnumber, validity=cue_validity_label,side=post_event_pos_label, post_hit, post_RT) %>%
  ungroup()

model2_valXside <-lmerTest::lmer(post_RT ~ validity * side + ( 1 | subject),
                  data=lmer_model_data2, REML=TRUE)
model_estimation2 <- lmerTest::step(model2_valXside, ddf="Satterthwaite", reduce.random=FALSE)
# model_estimation2 <- lmerTest::step(model2_valXside, ddf="Kenward-Roger", reduce.random=FALSE)
best_model2 <- get_model(model_estimation2)
# ranova(model2_valXside)
# anova(model2_valXside)

# print model estimation
model_estimation2$fixed %>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")) %>%
  mutate(`eliminated factor` = rownames(model_estimation2$fixed)) %>%
  dplyr::select(colnames(.)[c(8,1:7)]) %>%
  kable(escape = F, digits = c(3,3,3,3), caption = c("fixed effects | stepwise elimination")) %>%
  kable_styling("striped", full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8),position = "left")


```

2.  model description of best model
    + Best model is **`r toString(best_model2@call)`**
<br>

``` {r linear mixed model RT 02 - display, fig.height=6, fig.width=10, warning=FALSE}

model2test = best_model2

plot_model(model2test, bpe.style = "dot",show.values = TRUE)
plot_model(model2test, type = "pred", terms = c("side","validity"))
plot_model(model2test, type = "pred", terms = c("validity","side"))


```

### linear mixed models RR
<br>

1.  **estimating model**
<br>

linear mixed model of standard effects based on averaged data

testing **response rate ~ Validitaet * Seite + ( 1 | subjects)**


```{r linear mixed model RR 01 - estimation, echo=FALSE, message=FALSE}

lmer_model_data <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  group_by(subject, cue_validity_label, post_event_pos_label, post_hit) %>% 
  summarise(n_resp= n(), mean_RT = mean(post_RT)) %>%
  ungroup()%>%
  group_by(subject, cue_validity_label, post_event_pos_label) %>%
  mutate(n_cons = sum(n_resp), rate_perc = (n_resp/n_cons)*100) %>%
  mutate(post_hit = ifelse(post_hit=="NaN","miss",ifelse(post_hit=="0","error","hit")))%>%
  filter(post_hit == "hit")%>%
  select(subject,validity=cue_validity_label,side=post_event_pos_label, post_hit, mean_RT, rate_perc, n_resp, n_cons) %>%
  ungroup()

model_valXside <-lmerTest::lmer(rate_perc ~ validity * side + ( 1 | subject),
                  data=lmer_model_data, REML=TRUE)
model_estimation <- lmerTest::step(model_valXside, ddf="Kenward-Roger", reduce.random=FALSE)
best_model <- get_model(model_estimation)

# print model estimation
model_estimation$fixed %>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")) %>%
  mutate(`eliminated factor` = rownames(model_estimation$fixed)) %>%
  dplyr::select(colnames(.)[c(8,1:7)]) %>%
  kable(escape = F, digits = c(3,3,3,3), caption = c("fixed effects | stepwise elimination")) %>%
  kable_styling("striped", full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8),position = "left")
```
2.  model description of best model
    + Best model is `r toString(best_model@call)`  
<br>

``` {r linear mixed model RR 01 - display, fig.height=6, fig.width=10, warning=FALSE}

model2test = best_model
model2test = model_valXside

## validity
anova_lsmeans_c <- lsmeans(model2test, c("validity")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = validity, y = lsmean, color = validity, fill = validity, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.4),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for validity") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0, -0),
            nudge_y = c(26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")
  
## Seite
anova_lsmeans_c <- lsmeans(model2test, c("side")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = side, y = lsmean, color = side, fill = side, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.4),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for side") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0, -0),
            nudge_y = c(26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")

## Validiaet X Seite
anova_lsmeans_c <- lsmeans(model2test, c("side","validity")) 
CLD_obj = CLD(anova_lsmeans_c,
          alpha=0.05,
          Letters=letters,      ### Use lower-case letters for .group
          adjust="holm")
CLD_obj$.group=gsub(" ", "", CLD_obj$.group)

ggplot(CLD_obj, aes(x = validity, y = lsmean, color = side, fill = side, label = .group)) +
  stat_summary(fun.data = mean_se, geom = "bar", position = "dodge") +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.4, size=.9, position = position_dodge(0.9),color = "black") +
  theme_bw() +
  theme(axis.title = element_text(face = "bold"), axis.text = element_text(face = "bold"),plot.caption = element_text(hjust = 0)) +
  ylab("reaction time in ms") +
  ggtitle("modelled reaction times", 
           subtitle="separate for side") +
  scale_x_discrete("validity") +
  labs(caption  = paste0("\nMeans sharing a letter are ",
                         "not significantly different.",
                         "(holm corrected comparisons)."), hjust=0.5) +
  geom_text(nudge_x = c(0.22, -0.22, 0.22, -0.22),
            nudge_y = c(26.7,  26.7,26.7,  26.7),
            color   = "black")+ 
  scale_fill_brewer(palette = "Dark2")+
  scale_color_brewer(palette = "Dark2")


plot_model(model2test, bpe.style = "dot",show.values = TRUE)
plot_model(model2test, type = "pred", terms = c("side","validity"))
plot_model(model2test, type = "pred", terms = c("validity","side"))

```

### linear mixed models RR II
<br>

1.  **estimating model**
<br>

linear mixed model of standard effects based on single trial data

testing **reaction time ~ Validitaet * Seite + ( 1 | subjects)**


```{r linear mixed model 02 - estimation, echo=FALSE, message=FALSE}
lmer_model_data2 <- DATA.In_long %>%
  filter(trial_timing_type == 1) %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, post_hit, post_RT) %>%
  select(subject,trialnumber, validity=cue_validity_label,side=post_event_pos_label, post_hit, post_RT) %>%
  ungroup()%>%
  mutate(post_hit = ifelse(post_hit=="TRUE",1,0))

model2_valXside <-lmerTest::lmer(post_hit ~ validity * side + ( 1 | subject),
                  data=lmer_model_data2, REML=TRUE)
model_estimation2 <- lmerTest::step(model2_valXside, ddf="Satterthwaite", reduce.random=FALSE)
# model_estimation2 <- lmerTest::step(model2_valXside, ddf="Kenward-Roger", reduce.random=FALSE)
best_model2 <- get_model(model_estimation2)
# ranova(model2_valXside)


# print model estimation
model_estimation2$fixed %>%
  mutate(
    `Pr(>F)` = cell_spec(ifelse(round(`Pr(>F)`,4)<.001,"< .001",round(`Pr(>F)`,4)), 
                        color = ifelse(is.nan(`Pr(>F)`),"blue", ifelse(`Pr(>F)` < .05, "green", "red")),
                        bold = ifelse(is.nan(`Pr(>F)`),F, ifelse(`Pr(>F)` < .05, T,F)),
                        align = "center")) %>%
  mutate(`eliminated factor` = rownames(model_estimation2$fixed)) %>%
  dplyr::select(colnames(.)[c(8,1:7)]) %>%
  kable(escape = F, digits = c(3,3,3,3), caption = c("fixed effects | stepwise elimination")) %>%
  kable_styling("striped", full_width = F, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8),position = "left")


```

2.  model description of best model
    + Best model is **`r toString(best_model2@call)`**
<br>

``` {r linear mixed model 02 - display, fig.height=6, fig.width=10, warning=FALSE}

model2test = best_model2
model2test = model2_valXside

plot_model(model2test, bpe.style = "dot",show.values = TRUE)
plot_model(model2test, type = "pred", terms = c("side","validity"))
plot_model(model2test, type = "pred", terms = c("validity","side"))


```