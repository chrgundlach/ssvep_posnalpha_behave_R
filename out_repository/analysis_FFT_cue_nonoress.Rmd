---
title: "Analysis of general effects for Neural Measures |  Posner+SSVEP paradigm"
author: '[Christopher Gundlach](https://www.researchgate.net/profile/Christopher_Gundlach)'
date: '`r Sys.Date()`'
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
    theme: flatly
---
# Initialisierung  
**Setting up R libraries**

```{r set up libraries,echo=FALSE,warning=FALSE,message=FALSE,results="hide"}
# Setup the work environment
options(width=120,scipen=0,digits=6) # change output width (for better printing), scientific notation (to disable it: scipen=999), constrain output to 3 decimals
cat("\014") # clear console
# dev.off() # clear plots (if no plots are present, comment it out or it will throw an error)
rm(list=ls()) # clear environment
# wd="C:/.../ssvep_posnalpha_behave/" # work directory
# setwd(wd) # set work directory

# Load relevant libraries:



library(plyr)
library(psych)
library(ez)
library(ggplot2)
library(schoRsch)
library(lsr)
library(kableExtra)
library(ggbeeswarm)
library(afex)
library(lmerTest)
library(emmeans)
library(lsmeans)
library(sjPlot)
library(viridis)
library(multcomp)

library(cowplot)
library(dplyr)
library(readr)

library(ggpol)
library(ggpubr)
library(tidyverse)
library(effectsize)

library(broom)

library(ggdist)
library(multipanelfigure)
library(ggtern)

library(DescTools)
library(BayesFactor)

source(file = 'R_rainclouds.R')


# datafile1 <- "D:/experimental_data/2024_PosnalphaBehave_Repository/data/eeg/Behavior_FFT_singletrials_cue.txt"
datafile1 <- "C:/Users/EEG/Documents/R/Christopher/ssvep_posnalpha_behave_R/data_in/Behavior_FFT_singletrials_cue_nonoress.txt"
datafile1 <- "C:/Users/psy05cvd/Dropbox/work/R-statistics/experiments/ssvep_posnalpha_behave/data_in/Behavior_FFT_singletrials_cue_nonoress.txt"
# datafile1 <- ".../data/eeg/Behavior_FFT_singletrials_cue.txt" # adapt path to 
timewindows = c("[-1000 0]ms", "[0 1000]ms", "[500 1500]ms")

```
<style type="text/css">
.main-container {
  max-width: 1800px !important;
  margin-left: auto;
  margin-right: auto;
}
</style>

# Analysis of electrophysiological data (Posner Paradigma)  
<br>  

## subaveraged Daten werden geladen
Loading data `r toString(datafile1)`

The data has the following structure

* trialnumber = trial
* blocknumber
* trial_timing_type = 1=regular; 2=control
* cue_validity = 1=valid, 2=invalid, 3=neutral
* cue_validity_label
* cue_direction = 1=left, 2=right
* cue_direction_label
* cue_onset_fr = frame number of cue presentation
* cue_onset_t_est = onset time in ms
* cue_onset_t_meas = nan
* pre_event_type = 1=shorter, 2=longer, NaN=no event
* pre_event_onset_fr = onset frame of event
* pre_event_onset_t_est = onset time in ms
* pre_event_onset_t_meas = nan
* post_event_pos = position of post event: 1 = left, 2=right
* post_event_pos_label
* post_event_direction = direction of target (-90:90)=top; 
* post_event_direction_c = category of target position: 1=top; 2=bottom
* post_event_direction_c_l = label
* post_event_dimenstion = size in degrees
* post_event_onset_fr = onset frames of event
* post_event_onset_t_est = onset times of events
* post_event_onset_t_meas = nan
* triggernum = trigger number
* pre_hit = empty=no event, TRUE=hit, 0=error, NaN=miss
* pre_RT = RT in ms
* post_hit = TRUE=hit, 0=error, NaN=miss
* post_RT = RT in ms
* subject
* FFT measures ...



```{r load data,echo=FALSE,warning=FALSE,message=FALSE,results="hide"}
# Load the data
DATA.In_long <- read.csv(datafile1, header=TRUE,check.names=FALSE, sep =",", dec = ".")
#str(DATA.In_long)
DATA.In_long$trialnumber <- as.factor(DATA.In_long$trialnumber)
DATA.In_long$blocknumber <- as.factor(DATA.In_long$blocknumber)
DATA.In_long$trial_timing_type <- as.factor(DATA.In_long$trial_timing_type)
DATA.In_long$cue_validity <- as.factor(DATA.In_long$cue_validity)
DATA.In_long$cue_direction <- as.factor(DATA.In_long$cue_direction)
DATA.In_long$pre_event_type <- as.factor(DATA.In_long$pre_event_type)
DATA.In_long$post_event_pos <- as.factor(DATA.In_long$post_event_pos)
DATA.In_long$post_event_direction_c <- as.factor(DATA.In_long$post_event_direction_c)

DATA.In_long <- DATA.In_long %>%
  mutate(post_hit = case_when(
    post_hit == "1" ~ "hit",
    post_hit == "NaN" ~ "miss",
    post_hit == "0" ~ "error"
  ))
```

# Manipulation of data
long into wide format


```{r edit data,echo=FALSE,warning=FALSE,message=FALSE,results="hide"}
DATA.In_longer <- DATA.In_long %>%
  pivot_longer(
    cols = SSVEP_leftStim_win1:visualAlpha_rightStim_win3,
    names_to = c("signal","side","time"),
    names_pattern = "(.*)_(.*)_(.*)",
    values_to = "amplitude"
  ) %>%
  mutate(pos_rel_target = as.factor(ifelse(
    post_event_pos_label == "left" & (side == "leftHand" | side == "leftStim"), "contra_target", ifelse(
      post_event_pos_label == "right" & (side == "leftHand" | side == "leftStim"), "contra_nontarget", ifelse(
        post_event_pos_label == "left" & (side == "rightHand" | side == "rightStim"), "contra_nontarget", "contra_target"
      )
    ))
  ))%>%
  mutate(attention = case_when(
    pos_rel_target == "contra_target" & cue_validity_label == "valid" ~ "cued",
    pos_rel_target == "contra_target" & cue_validity_label == "invalid" ~ "uncued",
    pos_rel_target == "contra_nontarget" & cue_validity_label == "valid" ~ "uncued",
    pos_rel_target == "contra_nontarget" & cue_validity_label == "invalid" ~ "cued",
    cue_validity_label == "neutral" ~ "neutral"
  ))%>%
  mutate(attention = factor(attention, levels=c('uncued','neutral','cued'), ordered = T))%>%
  mutate(time=case_when(
      time == "win1" ~ timewindows[1],
      time == "win2" ~ timewindows[2],
      time == "win3" ~ timewindows[3]
  )) %>%
  # attempt to zscore data
  group_by(subject, signal, side, time)%>%
  mutate("Zamplitude" = scale(amplitude))%>%
  ungroup
 

  # mapvalues(DATA.In_longer$time, from=c("win1", "win2","win3"), to=timewindows)

```

# Illustration of Data  
<br> 

## Plots
<br> 

Illustrate Data as is

* plot modulation pooled across left and right side ~and only hits~

<br>  

```{r plot_data_st4, results = "hide",  fig.height=3.5, fig.width=2.5, warning = FALSE}
# str(DATA.In_longer)
dat_plot <- DATA.In_longer %>%
  filter(post_hit == "hit") %>%
  dplyr::select(subject, trialnumber, post_event_pos_label, signal, time, amplitude, attention)%>%
  group_by(subject, post_event_pos_label, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  pivot_wider(names_from = "time", values_from = amplitude) %>%
  mutate(pre_to_post = ((`[500 1500]ms`/`[-1000 0]ms`)-1)*100)%>%
  # mutate(pre_to_post = `[500 1500]ms`-`[-1000 0]ms`)%>%
  pivot_longer(`[-1000 0]ms`:pre_to_post, names_to = "time", values_to = "amplitude") %>%
  group_by(subject, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  filter(time == "pre_to_post")

dat2plot <- dat_plot %>%
  filter(signal == "SSVEP")

### for saving with alpha = 1
#induced baseline corrected####

theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = attention, y = amplitude, fill = attention)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subject,time)),colour = "grey60",alpha = 1,size =1) +
  geom_beeswarm(aes(color = attention, x = attention,
                    group = attention), cex=1.5, size = 4,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = attention, x = interaction(time,condition),
  #                   group = attention), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =attention), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("attention", breaks=waiver(), labels = rep(c(""),1,3)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  # labs(title=sprintf("SSVEP modulation | evoked"),
  #      subtitle="collapsed across frequencies")+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-25, 40))


plot2 <- ggplot(dat2plot, aes(y = amplitude, fill = attention, x = 1)) +
  geom_flat_violin(aes(fill = attention),position = position_nudge(x = .1, y = 0), adjust = 1, trim = FALSE, alpha = 1, colour = NA)+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-25, 40))



plotttitle <- ggdraw() + draw_label("SSVEP modulation", fontface='bold')
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(4,1))
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))
# ggsave(filename = "figures/SSVEP_Mod.eps", width = 2.5, height = 3.5,
#        plot = print(saveplot))
print(saveplot)


dat2plot <- dat_plot %>%
  filter(signal == "visualAlpha")

### for saving with alpha = 1
#induced baseline corrected####
theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = attention, y = amplitude, fill = attention)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subject,time)),colour = "grey60",alpha = 1,size =1) +
  geom_beeswarm(aes(color = attention, x = attention,
                    group = attention), cex=1.5, size = 4,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = attention, x = interaction(time,condition),
  #                   group = attention), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =attention), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("attention", breaks=waiver(), labels = rep(c(""),1,3)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  # labs(title=sprintf("SSVEP modulation | evoked"),
  #      subtitle="collapsed across frequencies")+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-30, 30))


plot2 <- ggplot(dat2plot, aes(y = amplitude, fill = attention, x = 1)) +
  geom_flat_violin(aes(fill = attention),position = position_nudge(x = .1, y = 0), adjust = 1, trim = FALSE, alpha = 1, colour = NA)+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-30, 30))



plotttitle <- ggdraw() + draw_label("visual alpha modulation", fontface='bold')
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(4,1))
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))
# ggsave(filename = "figures/VisAlpha_Mod.eps", width = 2.5, height = 3.5,
#        plot = print(saveplot))
print(saveplot)


dat2plot <- dat_plot %>%
  filter(signal == "motorAlpha")

### for saving with alpha = 1
#induced baseline corrected####
theme_set(theme_bw())
plot1 <- ggplot(dat2plot, aes(x = attention, y = amplitude, fill = attention)) +
  geom_hline(yintercept=0, show.legend = FALSE) +
  geom_line(aes(group = interaction(subject,time)),colour = "grey60",alpha = 1,size =1) +
  geom_beeswarm(aes(color = attention, x = attention,
                    group = attention), cex=1.5, size = 4,alpha=1,fill="grey40",shape=21)+
  # geom_point(aes(color = attention, x = interaction(time,condition),
  #                   group = attention), size = 4,alpha=0.4)+
  stat_summary(fun.y=mean, aes(ymin=..y.., ymax=..y.., color =attention), geom='errorbar', width=0.9, size=1.5) +
  scale_x_discrete("attention", breaks=waiver(), labels = rep(c(""),1,3)) +
  # theme(legend.position="bottom") +
  ylab(expression(paste("amplitude modulation in %")))+
  # labs(title=sprintf("SSVEP modulation | evoked"),
  #      subtitle="collapsed across frequencies")+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(legend.position="none")+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-25, 25))


plot2 <- ggplot(dat2plot, aes(y = amplitude, fill = attention, x = 1)) +
  geom_flat_violin(aes(fill = attention),position = position_nudge(x = .1, y = 0), adjust = 1, trim = FALSE, alpha = 1, colour = NA)+
  scale_fill_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_fill_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_fill_brewer(palette = "Dark2")+
  scale_color_manual(values=c("#F1831A", "#293C4A", "#198A83"))+
  # scale_color_manual(values=c("#FFC876", "#162B3F", "#1A776F"))+
  # scale_color_brewer(palette = "Dark2")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  # scale_y_continuous(limits=c(-60, 140))
  scale_y_continuous(limits=c(-25, 25))



# cowplot::plot_grid(plot1, plot2, plot3, ncol = 3,labels = "AUTO")
plotttitle <- ggdraw() + draw_label("motor alpha modulation", fontface='bold')
plotplots <- ggarrange(plot1, plot2,ncol = 2,common.legend = TRUE,align = "h", widths=c(4,1))
saveplot <- ggarrange(plotttitle, plotplots, nrow = 2, heights=c(0.2, 1))
print(saveplot)
# ggsave(filename = "figures/MotorAlpha_Mod.eps", width = 2.5, height = 3.5,
#        plot = print(saveplot))

```


## decriptive data
<br>  


### electrophysiological measures

validity 

```{r EPM_valXside, echo=FALSE}
DATA.In_longer %>%
  filter(post_hit == "hit") %>%
  dplyr::select(subject, trialnumber, cue_validity_label, post_event_pos_label, signal, time, amplitude, pos_rel_target)%>%
  group_by(subject, cue_validity_label, post_event_pos_label, signal, time, pos_rel_target) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  pivot_wider(names_from = "time", values_from = amplitude) %>%
  mutate(pre_to_post = ((`[500 1500]ms`/`[-1000 0]ms`)-1)*100)%>%
  # mutate(pre_to_post = `[500 1500]ms`-`[-1000 0]ms`)%>%
  pivot_longer(`[-1000 0]ms`:pre_to_post, names_to = "time", values_to = "amplitude") %>%
  group_by(subject, cue_validity_label, signal, time, pos_rel_target) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  filter(time == "pre_to_post") %>%
  group_by(signal, cue_validity_label, pos_rel_target)%>%
  dplyr::summarise(M = mean(amplitude), SD = sd(amplitude))%>%
  ungroup()%>%
  mutate(cue_validity_label = factor(cue_validity_label, levels=c('invalid','neutral','valid'), ordered = T))%>%
  kable(escape = F, digits = c(3,3,3,6,3,3,3,3,3), caption = c("average electrophysiological measures")) %>%
  # kable_classic(full_width = F) %>%
  column_spec(1, bold = T)%>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

DATA.In_longer %>%
  filter(post_hit == "hit") %>%
  dplyr::select(subject, trialnumber, post_event_pos_label, signal, time, amplitude, attention)%>%
  group_by(subject, post_event_pos_label, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  pivot_wider(names_from = "time", values_from = amplitude) %>%
  mutate(pre_to_post = ((`[500 1500]ms`/`[-1000 0]ms`)-1)*100)%>%
  # mutate(pre_to_post = `[500 1500]ms`-`[-1000 0]ms`)%>%
  pivot_longer(`[-1000 0]ms`:pre_to_post, names_to = "time", values_to = "amplitude") %>%
  group_by(subject, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  filter(time == "pre_to_post") %>%
  group_by(signal, attention)%>%
  dplyr::summarise(M = mean(amplitude), SD = sd(amplitude))%>%
  ungroup()%>%
  kable(escape = F, digits = c(3,3,3,6,3,3,3,3,3), caption = c("average electrophysiological measures")) %>%
  # kable_classic(full_width = F) %>%
  column_spec(1, bold = T)%>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
 


```





## tests  
<br>  

test of general model

### ANOVA electrophysiological measures
<br>  

ANOVA_RM for electrophysiological measures: meas ~ ATTENTION(cued, neutral, uncued)

```{r ANOVA_RT_ValXSei, message=FALSE, warning=FALSE, include=TRUE}
#ANOVAe
DATA.In_longer %>%
  filter(post_hit == "hit") %>%
  dplyr::select(subject, trialnumber, post_event_pos_label, signal, time, amplitude, attention)%>%
  group_by(subject, post_event_pos_label, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  pivot_wider(names_from = "time", values_from = amplitude) %>%
  mutate(pre_to_post = ((`[500 1500]ms`/`[-1000 0]ms`)-1)*100)%>%
  # mutate(pre_to_post = `[500 1500]ms`-`[-1000 0]ms`)%>%
  pivot_longer(`[-1000 0]ms`:pre_to_post, names_to = "time", values_to = "amplitude") %>%
  group_by(subject, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  filter(time == "pre_to_post")%>%
  group_by(signal)%>%
  nest() %>%
  mutate(stats= purrr::map(data, ~broom::tidy(
    anova(aov_ez(id="subject", dv = "amplitude", data = ., within = "attention"))
  ))) %>%
  dplyr::select(-data) %>%
  unnest()%>%
  mutate(
    `p.value` = cell_spec(ifelse(round(`p.value`,4)<.001,"< .001",round(`p.value`,4)), 
                        color = ifelse(is.nan(`p.value`),"blue", ifelse(`p.value` < .05, "green", "red")),
                        bold = ifelse(is.nan(`p.value`),F, ifelse(`p.value` < .05, T,F)),
                        align = "center")
  ) %>%
  dplyr::select(signal, term, `num.Df`, `den.Df`, MSE, `statistic`, ges, `p.value`) %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("repeated measures ANOVA ")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))



```

### Post-hoc t-Tests electrophysiological measures (cued vs neutral vs uncued)  
<br>


```{r post-hoc t_tests RT, echo=FALSE}
dat2model <-DATA.In_longer %>%
  filter(post_hit == "hit") %>%
  dplyr::select(subject, trialnumber, post_event_pos_label, signal, time, amplitude, attention)%>%
  group_by(subject, post_event_pos_label, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  pivot_wider(names_from = "time", values_from = amplitude) %>%
  mutate(pre_to_post = ((`[500 1500]ms`/`[-1000 0]ms`)-1)*100)%>%
  # mutate(pre_to_post = `[500 1500]ms`-`[-1000 0]ms`)%>%
  pivot_longer(`[-1000 0]ms`:pre_to_post, names_to = "time", values_to = "amplitude") %>%
  group_by(subject, signal, time, attention) %>%
  dplyr::summarise(amplitude=mean(amplitude))%>%
  ungroup()%>%
  filter(time == "pre_to_post")

# models
anovamodel_SSVEP <- dat2model %>%
  filter(signal == "SSVEP") %>%
  aov_ez(id="subject", dv = "amplitude", data = ., within = "attention", include_aov = TRUE)
anovamodel_visalpha <- dat2model %>%
  filter(signal == "visualAlpha") %>%
  aov_ez(id="subject", dv = "amplitude", data = ., within = "attention", include_aov = TRUE)
anovamodel_motalpha <- dat2model %>%
  filter(signal == "motorAlpha") %>%
  aov_ez(id="subject", dv = "amplitude", data = ., within = "attention", include_aov = TRUE)

# posthocs
post_hocs.SSVEP <- emmeans(anovamodel_SSVEP$aov, "attention", contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.visalpha <- emmeans(anovamodel_visalpha$aov, "attention", contr = "pairwise",adjust = "holm") # adjust = holm
post_hocs.motalpha <- emmeans(anovamodel_motalpha$aov, "attention", contr = "pairwise",adjust = "holm") # adjust = holm

# output
post_hocs.SSVEP$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by att. focus | dv = SSVEP")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.SSVEP$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by att. focus | dv = SSVEP | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))


post_hocs.visalpha$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by att. focus | dv = visual alpha")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.visalpha$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by att. focus | dv = visual alpha | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

post_hocs.motalpha$emmeans %>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), caption = c("estimated marginal means | by att. focus | dv = motor alpha")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

summary(post_hocs.motalpha$contrasts) %>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  mutate(CohensD = `t.ratio`/sqrt(df+1))%>%
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | by att. focus | dv = motor alpha | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))


# posthocs manual contrast against zero
SSVEP.emm.s <- emmeans(anovamodel_SSVEP$aov, "attention")
visalpha.emm.s <- emmeans(anovamodel_visalpha$aov, "attention")
motalpha.emm.s <- emmeans(anovamodel_motalpha$aov, "attention")
emm_contrasts <- list(
  "uncued vs. 0" = c(1,0,0),
  "neutral vs. 0" = c(0,1,0),
  "cued vs. 0" = c(0,0,1)
)

# pairs(SSVEP.emm.s)
# pwpm(SSVEP.emm.s)
# coef(pairs(SSVEP.emm.s))

# ssveps
# summary(contrast(SSVEP.emm.s, method = emm_contrasts, adjust = "holm")) %>% # manual implementation
summary(contrast(SSVEP.emm.s, method = "identity", adjust = "holm")) %>% # same implementation
  mutate(`CohensD` =
           summary(eff_size(contrast(SSVEP.emm.s, method = "identity", adjust = "holm"),
                            sigma = sqrt(mean(sigma(anovamodel_SSVEP$lm)^2)), # RMS of sigma()
                            edf = df.residual(anovamodel_SSVEP$lm), method = "identity"))$effect.size
  )%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD2 = `t.ratio`/sqrt(df+1))%>% # not working with emmeans approach
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | against zero | dv = SSVEP modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# visual alpha
# summary(contrast(visalpha.emm.s, method = emm_contrasts, adjust = "holm")) %>% # manual implementation
summary(contrast(visalpha.emm.s, method = "identity", adjust = "holm")) %>% # same implementation
  mutate(`CohensD` =
           summary(eff_size(contrast(visalpha.emm.s, method = "identity", adjust = "holm"),
                            sigma = sqrt(mean(sigma(anovamodel_SSVEP$lm)^2)), # RMS of sigma()
                            edf = df.residual(anovamodel_SSVEP$lm), method = "identity"))$effect.size
  )%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD2 = `t.ratio`/sqrt(df+1))%>% # not working with emmeans approach
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | against zero | dv = vis alpha modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))

# motor alpha
# summary(contrast(motalpha.emm.s, method = emm_contrasts, adjust = "holm")) %>% # manual implementation
summary(contrast(motalpha.emm.s, method = "identity", adjust = "holm")) %>% # same implementation
  mutate(`CohensD` =
           summary(eff_size(contrast(motalpha.emm.s, method = "identity", adjust = "holm"),
                            sigma = sqrt(mean(sigma(anovamodel_SSVEP$lm)^2)), # RMS of sigma()
                            edf = df.residual(anovamodel_SSVEP$lm), method = "identity"))$effect.size
  )%>%
  mutate(
    p.value = cell_spec(ifelse(round(p.value,4)<.001,"< .001",round(p.value,4)), 
                        color = ifelse(is.nan(p.value),"blue", ifelse(p.value < .05, "green", "red")),
                        bold = ifelse(is.nan(p.value),F, ifelse(p.value < .05, T,F)),
                        align = "left")
  ) %>%
  # mutate(CohensD2 = `t.ratio`/sqrt(df+1))%>% # not working with emmeans approach
  kable(escape = F, digits = c(3,3,3,3,3,3,3,3,3), 
        caption = c("contrasts for estimated marginal means | against zero | dv = motor alpha modulation | corrected: Holm")) %>%
  kable_styling("striped", full_width = T, bootstrap_options = c("striped", "hover", "condensed", "responsive",font_size = 8))
```

